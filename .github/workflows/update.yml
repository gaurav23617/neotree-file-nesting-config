name: Auto Update Neo-tree Config

on:
  schedule:
    # Run every 10 days at 7 AM IST (which is 1:30 AM UTC)
    - cron: "30 1 */10 * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  update-config:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Neovim
        uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: stable

      - name: Fetch latest VSCode config
        id: fetch
        run: |
          echo "Fetching latest config from antfu/vscode-file-nesting-config..."

          # Fetch the README which contains the config
          curl -s https://raw.githubusercontent.com/antfu/vscode-file-nesting-config/main/README.md -o /tmp/README.md

          # Extract the update date
          UPDATE_DATE=$(grep -oP '// updated \K[0-9-]+ [0-9:]+' /tmp/README.md | head -1)
          echo "Update date from upstream: $UPDATE_DATE"
          echo "update_date=$UPDATE_DATE" >> $GITHUB_OUTPUT

          # Extract JSON config from the README (between ```jsonc and ```)
          echo "Extracting JSON config..."
          sed -n '/```jsonc/,/```/p' /tmp/README.md | sed '1d;$d' > /tmp/vscode-config.json

          # Verify we got the config
          if [ ! -s /tmp/vscode-config.json ]; then
            echo "Error: Failed to extract config from README"
            exit 1
          fi

          CONFIG_SIZE=$(wc -l < /tmp/vscode-config.json)
          echo "Extracted config: $CONFIG_SIZE lines"

          # Check if there's a difference with current config
          if [ -f "last_update.txt" ]; then
            LAST_UPDATE=$(cat last_update.txt)
            echo "Last update: $LAST_UPDATE"

            if [ "$UPDATE_DATE" = "$LAST_UPDATE" ]; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "✓ No updates available - config is up to date"
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "✓ New updates available!"
            fi
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "✓ First run - will generate config"
          fi

      - name: Convert to Neo-tree format
        if: steps.fetch.outputs.has_changes == 'true'
        run: |
          echo "Converting VSCode config to Neo-tree format..."

          # Run the conversion script with Neovim
          nvim --headless -u NONE -c "luafile build/convert.lua" -c "qa"

          # Check if files were generated
          if [ ! -f "./lua/neotree-file-nesting-config.lua" ]; then
            echo "Error: Failed to generate lua/neotree-file-nesting-config.lua"
            exit 1
          fi

          if [ ! -f "./README.md" ]; then
            echo "Error: Failed to generate README.md"
            exit 1
          fi

          echo "✓ Conversion completed successfully"

      - name: Update timestamp
        if: steps.fetch.outputs.has_changes == 'true'
        run: |
          echo "${{ steps.fetch.outputs.update_date }}" > last_update.txt
          echo "✓ Updated timestamp"

      - name: Check for changes
        id: git_check
        if: steps.fetch.outputs.has_changes == 'true'
        run: |
          git diff --quiet || echo "changed=true" >> $GITHUB_OUTPUT

          if git diff --quiet; then
            echo "No actual changes in generated files"
          else
            echo "✓ Changes detected in generated files"
            echo "Changed files:"
            git diff --name-only
          fi

      - name: Create Pull Request
        if: steps.fetch.outputs.has_changes == 'true' && steps.git_check.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update neo-tree nesting config from upstream"
          title: "Auto-update: Neo-tree nesting config"
          body: |
            ## Auto-generated update

            This PR updates the Neo-tree file nesting configuration based on the latest changes from [antfu/vscode-file-nesting-config](https://github.com/antfu/vscode-file-nesting-config).

            **Update date:** ${{ steps.fetch.outputs.update_date }}

            ### Changes
            -  Fetched latest nesting rules from upstream VSCode config
            -  Converted to Neo-tree Lua format
            -  Updated README with latest rules
            -  Updated timestamp

            ### Files Changed
            - `lua/neotree-file-nesting-config.lua` - Updated nesting rules
            - `README.md` - Updated documentation

            Please review the changes before merging.

            ---

            *This PR was automatically generated by the update workflow.*
          branch: auto-update-config
          delete-branch: true
          labels: |
            automated
            dependencies
          assignees: saifulapm
